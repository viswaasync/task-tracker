<!DOCTYPE html>
<html>
<head>
  <title>Research Group Task Tracker</title>
  <link rel="stylesheet" href="main.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="menu-bar">
    <div>
      <a href="#">Home</a>
      <a href="#">View</a>
      <a href="#">Update</a>
      <h1>Research Group Task Tracker</h1>
    </div>
  </div>

  

  <div class="landing-section">
    <h2>Task Assignment Form</h2>
    <div class="input-form">
      <label for="week">Week Number:</label>
      <input type="text" id="week" placeholder="Week number"><br><br>
      <label for="order">Order Number:</label>
      <input type="text" id="order" placeholder="Order number"><br><br>
      <label for="project">Project:</label>
      <select id="project">
        <option value="PROBIO">PROBIO</option>
        <option value="CRCR">CRCR</option>
        <option value="IPCM">IPCM</option>
        <option value="PSFF">PSFF</option>
      </select><br><br>
      <label for="task">Task:</label>
      <select id="task">
        <option value="lab">Lab Work</option>
        <option value="analysis">Data Analysis</option>
        <option value="curation">Data Curation</option>
      </select><br><br>
      <label for="responsible">Responsible:</label>
      <select id="responsible">
        <option value="Johan">Johan</option>
        <option value="Markus">Markus</option>
        <option value="Rebecka">Rebecka</option>
        <option value="Anu">Anu</option>
        <option value="Preeti">Preeti</option>
        <option value="Venki">Venki</option>
        <option value="Sarath">Sarath</option>
        <option value="Nawal">Nawal</option>
        <option value="Karthick">Karthick</option>
      </select><br><br>
      <button class="update-button" onclick="updateSchedule()">Update Schedule</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-button active" onclick="openTab(event, 'lab-tab')" id="lab-tab-button">Lab Work</button>
    <button class="tab-button" onclick="openTab(event, 'analysis-tab')" id="analysis-tab-button">Data Analysis</button>
    <button class="tab-button" onclick="openTab(event, 'curation-tab')" id="curation-tab-button">Data Curation</button>
  </div>

  <div id="lab-tab" class="tab-content">
    <h2>Lab Work</h2>
    <table>
      <thead>
        <tr>
          <th>Week Number</th>
          <th>Date</th>
          <th>Order Number </th>
          <th>Project</th>
          <th>Task</th>
          <th>Responsible</th>
        </tr>
      </thead>
      <tbody id="lab-table">
        <!-- Placeholder rows for lab work, dynamically populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <div id="analysis-tab" class="tab-content">
    <h2>Data Analysis</h2>
    <table>
      <thead>
        <tr>
          <th>Week Number</th>
          <th>Date</th>
          <th>Order Number </th>
          <th>Project</th>
          <th>Task</th>
          <th>Responsible</th>
        </tr>
      </thead>
      <tbody id="analysis-table">
        <!-- Placeholder rows for data analysis, dynamically populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <div id="curation-tab" class="tab-content">
    <h2>Data Curation</h2>
    <table>
      <thead>
        <tr>
          <th>Week Number</th>
          <th>Date</th>
          <th>Order Number</th>
          <th>Project</th>
          <th>Task</th>
          <th>Responsible</th>
        </tr>
      </thead>
      <tbody id="curation-table">
        <!-- Placeholder rows for data curation, dynamically populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <script>
    function openTab(evt, tabName) {
      // Tab switching logic
    }
  
    function updateSchedule() {
      // Get form input values
      const week = document.getElementById('week').value;
      const order = document.getElementById('order').value;
      const project = document.getElementById('project').value;
      const task = document.getElementById('task').value;
      const responsible = document.getElementById('responsible').value;
  
      // Send the task data to the server
      fetch('/api/tasks', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ week, order, project, task, responsible })
      })
      .then(response => {
        if (response.ok) {
          // Task saved successfully, update the table dynamically
          return response.json();
        } else {
          throw new Error('Failed to save the task');
        }
      })
      .then(task => {
        // Update the table with the new task dynamically
        const { week, order, project, task: taskName, responsible } = task;
        const tableId = `${taskName}-table`;
        const table = document.getElementById(tableId);
        
        // Create a new row and insert cells with task details
        const row = table.insertRow();
        const weekCell = row.insertCell(0);
        const dateCell = row.insertCell(1);
        const orderCell = row.insertCell(2)
        const projectCell = row.insertCell(3);
        const taskCell = row.insertCell(4);
        const responsibleCell = row.insertCell(5);
  
        weekCell.textContent = week;
        dateCell.textContent = convertWeekToDateRange(week);
        orderCell.textContent = order_number;
        projectCell.textContent = project;
        taskCell.textContent = taskName;
        responsibleCell.textContent = responsible;
        responsibleCell.classList.add('selected');
      })
      .catch(error => {
        console.error(error);
      });
    }
  
    // Function to convert week number to date range
    function convertWeekToDateRange(weekNumber) {
  var date = new Date();
  var offset = date.getTimezoneOffset();

  // Set the date to January 1st of the current year
  date.setMonth(0);
  date.setDate(1);

  // ISO: week 1 is the one with the year's first Thursday
  // Nearest Thursday: current date + 4 - current day number
  // Sunday is converted from 0 to 7
  date.setDate(date.getDate() + 4 - (date.getDay() || 7));

  // Subtract one day from the date to start from January 1st
  date.setDate(date.getDate() + 3);

  // 7 days * (week - 1)
  date.setTime(date.getTime() + 7 * 24 * 60 * 60 * 1000 * (weekNumber - 1));

  // Daylight savings fix
  date.setTime(date.getTime() + (date.getTimezoneOffset() - offset) * 60 * 1000);

  const endDate = new Date(date);
  endDate.setDate(date.getDate() + 6);
  const startMonth = date.toLocaleString('default', { month: 'short' });
  const startDay = date.getDate();
  const endMonth = endDate.toLocaleString('default', { month: 'short' });
  const endDay = endDate.getDate();

  return `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
}
  
    // Fetch tasks from the server and populate the tables
    fetch('/api/tasks')
      .then(response => response.json())
      .then(tasks => {
        tasks.forEach(task => {
          const { week, order_number, project, task: taskName, responsible } = task;
          const tableId = `${taskName}-table`;
          const table = document.getElementById(tableId);
          
          // Create a new row and insert cells with task details
          const row = table.insertRow();
          const weekCell = row.insertCell(0);
          const dateCell = row.insertCell(1);
          const orderCell = row.insertCell(2)
          const projectCell = row.insertCell(3);
          const taskCell = row.insertCell(4);
          const responsibleCell = row.insertCell(5);
  
          weekCell.textContent = week;
          dateCell.textContent = convertWeekToDateRange(week);
          orderCell.textContent = order_number;
          projectCell.textContent = project;
          taskCell.textContent = taskName;
          responsibleCell.textContent = responsible;
          responsibleCell.classList.add('selected');
        });
      })
      .catch(error => {
        console.error(error);
      });
  
    function openTab(evt, tabName) {
      var i, tabContent, tabButtons;
      tabContent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabContent.length; i++) {
        tabContent[i].style.display = "none";
      }
      tabButtons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }
  </script>
  
</body>
</html>
